# AWS F1インスタンスを使ってみる

Amazon EC2 F1 インスタンスは、FPGA を使用できるインスタンスです。

このページでは、まず、AWS FPGA Hardware Development Kit (HDK)のサンプルの cl_hello_world を実行してみて、その後、Chiselで書いたプロジェクトを動かしてみます。

## cl_hello_worldを実行する

### 概略

作業の流れは、以下の通りです。

1. FPGAイメージの開発用のEC2インスタンス(以降、開発用インスタンスと呼びます)をセットアップ
2. 開発用インスタンスでFPGAイメージをビルドしてS3にアップロード
3. Amazon EC2 F1 インスタンス(以降、実行用F1インスタンスと呼びます)をセットアップ
4. 実行用F1インスタンスでS3にアップロードされたFPGAイメージをロード
5. FPGAの機能を呼び出すプログラムを実行

実行用F1インスタンスで開発用インスタンスを兼用する事もできますが、実行用F1インスタンスの料金は高いので、FPGAイメージのビルド作業は料金の安い普通のEC2インスタンス(それでも32GiB以上のメモリが必須)で行います。

インスタンスの料金(リージョンは米国西部 (オレゴン)。2020/10/2現在。F1インスタンスは4倍ぐらい違う)

| 用途 | インスタンス | 料金 |
| 開発用 | m4.2xlarge | 0.40USD/時間 |
| 実行用 | f1.2xlarge | 1.65USD/時間 |

F1 インスタンスを利用できるのは、以下のリージョンです。

* 米国東部 (バージニア北部)
* 米国西部 (オレゴン)
* 欧州 (アイルランド)
* アジアパシフィック (シドニー)

### 開発用インスタンスのセットアップ

#### インスタンスの作成

AWSのコンソール画面で以下を実施します。

1. 「EC2 ダッシュボード」で「インスタンスを起動」ボタンをクリック
2. 「AMIの選択」で、「AWS Marketplace」にある「FPGA Developer AMI」を「選択」
3. 「インスタンスタイプの選択」で「m4.2xlarge」を選択
4. 「インスタンスの設定」はデフォルトのままで、次のステップへ
5. 「ストレージの追加」では「ルート」ボリュームのサイズを「160GiB」に変更し、2つ目のボリュームは削除
6. 「タグの追加」は追加せずに、次のステップへ
7. 「セキュリティグループの設定」はデフォルトのままで、次のステップへ(本当はソースのIPを制限すべきだが...)
8. 「確認」で「起動」をクリックし、キーペアの作成等を行い、キーペアを自分のPCに配置する。
9. インスタンスが起動したら、インスタンスの「パブリックIP v4アドレス」を調べる。
10. 「インスタンスの設定」で「IAMロールを変更」
11. 「新しいIMロールを作成」
12. 「ロールの作成」
13. 「EC2」を選択して、「次のステップ」
14. 「AdministratorAccess」を選択して、「次のステップ」
15. 「タグ」は追加しない
16. 「ロール名」を設定して、「ロールの作成」
17. 「IAMロールを変更」のタブに戻ってロールを選択して保存

#### インスタンスへのログイン

SSHで、先程作成したキーペアを使って、ユーザ名:`centos`、ホスト:`インスタンスのパブリックIP v4アドレス`を指定してログインします。

sshコマンドを使う場合は以下のようにします。

```bash
ssh -i ~/.ssh/キーペアファイル名 centos@IPアドレス
```

パッケージを更新します。

```bash
sudo yum update -y
```

#### S3バケットの作成

AFIイメージを保存するS3バケットを作成します。

```
aws s3 mb s3://バケット名 --region us-west-2
```
